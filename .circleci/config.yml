version: 2.1

orbs:
  aws-ecr: johnpc/aws-ecr-orb@1.0.6

jobs:
  build:
    docker:
      - image: circleci/node:12
    steps:
      - setup_remote_docker
      - aws-ecr/build-and-push-image:
          aws-access-key-id: ECR_PUSH_ACCESS_KEY
          aws-secret-access-key: ECR_PUSH_SECRET_ACCESS_KEY
          aws-session-token: ECR_PUSH_SESSION_TOKEN
          region: ECR_REGION
          checkout: true
          create-repo: false
          dockerfile: Dockerfile
          repo: amplify-cli-e2e-base-image-repo-public
          tag: "latest,${CIRCLE_SHA1}"

workflows:
  build_and_push_image:
    jobs:
      - build:
          context: amplify-cli-ecr
          filters:
            branches:
              only:
                - e2e-image-build
