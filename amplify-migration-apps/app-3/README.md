# Personal Media Vault - Amplify Gen1 Setup Guide

A personal media management application built with Amplify Gen1, featuring social authentication, GraphQL API, Lambda functions, S3 storage, and DynamoDB.

## Categories

### api
GraphQL API with schema containing UserProfile, MediaItem, Collection, SharedItem, and Note models with relationships. Uses Cognito User Pool for default auth with API key as additional auth type.

### auth
Cognito-based authentication using email/phone with social providers (Facebook, Google). Includes user groups: Admin and Basic (manually assigned).

### storage
- DynamoDB tables for UserProfile, MediaItem, Collection, SharedItem, and Note (auto-generated by @model directive)
- S3 bucket for authenticated users to create/update, read, and delete media files; guest users have read access

### function
Node.js Lambda function (thumbnailgen) for automatic thumbnail generation on S3 uploads.

## Description

This is a personal media vault with social authentication. Users can upload images, videos, and documents to S3, organize them in collections, and share with others. The app features real-time thumbnail processing via Lambda.

Users sign up with email/phone or social login (Facebook/Google). Media files are stored in S3 bucket with auth and guest read access. Thumbnail generation is handled via Lambda function triggered on upload. All data uses DynamoDB tables auto-generated by Amplify's @model directive. CRUD operations are via GraphQL with AWS AppSync. Auth is managed through Cognito with social providers. User groups (Admin/Basic) must be manually assigned.

---

### Step 1: Initialize the project

```
amplify init
```
```
Do you want to continue with Amplify Gen 1? (y/N) · yes
Why would you like to use Amplify Gen 1? · Prefer not to answer
Enter a name for the project personalmediavault

The following configuration will be applied:
Project information
| Name: personalmediavault
| Environment: dev
| Default editor: Visual Studio Code
| App type: javascript
| Javascript framework: react
| Source Directory Path: src
| Distribution Directory Path: build
| Build Command: npm run-script build
| Start Command: npm run-script start

? Initialize the project with the above configuration? Yes
Using default provider awscloudformation
? Select the authentication method you want to use: AWS profile
? Please choose the profile you want to use: default
```

### Step 2: Add Authentication

```
amplify add auth
```
```
Using service: Cognito, provided by: awscloudformation

The current configured provider is Amazon Cognito.

Do you want to use the default authentication and security configuration? Default configuration with Social Provider (Federation)
Warning: you will not be able to edit these selections.
How do you want users to be able to sign in? Email or Phone Number
Do you want to configure advanced settings? No, I am done.
What domain name prefix do you want to use? personalmediavaultXXXXX
Enter your redirect signin URI: http://localhost:3000/
? Do you want to add another redirect signin URI No
Enter your redirect signout URI: http://localhost:3000/
? Do you want to add another redirect signout URI No
Select the social providers you want to configure for your user pool: Facebook, Google
```

**Facebook Setup:**

1. While logged into your Facebook account, go to https://developers.facebook.com/async/registration
   - Agree to the terms
   - Verify account
   - Select dev occupation

2. Go to https://developers.facebook.com/apps/
   - Click on create app
   - Name: amplify test
   - Select authenticate and request data from users with Facebook login
   - Business portfolio - I don't want to connect a business portfolio yet

3. On the left navigation bar, choose Settings and then Basic
   - Copy App ID
   - Copy App secret
```
You've opted to allow users to authenticate via Facebook. If you haven't already, you'll need to go to https://developers.facebook.com and create an App ID.

Enter your Facebook App ID for your OAuth flow: XXXXX
Enter your Facebook App Secret for your OAuth flow: XXXXX
```

**Google Setup:**

1. Go to https://console.developers.google.com/
   - On the left navigation bar, look for credentials under APIs and Services under Pinned
   - Click create project with name amplify test
   - Click on create credentials in the top bar and select OAuth client ID
   - Click on configure consent screen
   - Get started with branding
   - Add app name and your support email, external org and contact info

2. Click on create OAuth client
   - Application type: Web application
   - Name: amplify client
   - Click create
   - Copy client id and client secret
```
You've opted to allow users to authenticate via Google. If you haven't already, you'll need to go to https://developers.google.com/identity and create an App ID.


Enter your Google Web Client ID for your OAuth flow: XXXXX
Enter your Google Web Client Secret for your OAuth flow: XXXXX
```

### Step 3: Add User Groups

```
amplify update auth
```
```
What do you want to do? Create or update Cognito user pool groups
? Provide a name for your user pool group: Admin
? Do you want to add another User Pool Group Yes
? Provide a name for your user pool group: Basic
? Do you want to add another User Pool Group No
✔ Sort the user pool groups in order of preference · Admin, Basic
```

### Step 4: Add GraphQL API

```
amplify add api
```
```
? Select from one of the below mentioned services: GraphQL
? Here is the GraphQL API that we will create. Select a setting to edit or continue Authorization modes: API key (default, expiration time: 7 days from now)
? Choose the default authorization type for the API Amazon Cognito User Pool
Use a Cognito user pool configured as a part of this project.
? Configure additional auth types? Yes
? Choose the additional authorization types you want to configure for the API API key
API key configuration
✔ Enter a description for the API key: · testing
✔ After how many days from now the API key should expire (1-365): · 100
? Choose a schema template: Single object with fields (e.g., "Todo" with ID, name, description)

✔ Do you want to edit the schema now? (Y/n) · yes

Edit the file in your editor: /amplify/backend/api/<apiName>/schema.graphql
```

```graphql
type UserProfile @model @auth(rules: [
  { allow: owner },
  { allow: groups, groups: ["Admin"] }
]) {
  id: ID!
  username: String!
  email: String
  displayName: String
  avatar: String
}

type MediaItem @model @auth(rules: [
  { allow: owner },
  { allow: groups, groups: ["Admin"] }
]) {
  id: ID!
  title: String!
  description: String
  fileUrl: String!
  thumbnailUrl: String
  fileType: MediaType!
  fileSize: Int
  mimeType: String
  tags: [String]
  isPrivate: Boolean!
  uploadedAt: AWSDateTime!
}

type Collection @model @auth(rules: [
  { allow: owner },
  { allow: groups, groups: ["Admin"] }
]) {
  id: ID!
  name: String!
  description: String
  coverImage: String
  isPrivate: Boolean!
}

type SharedItem @model @auth(rules: [
  { allow: owner },
  { allow: private, operations: [read] }
]) {
  id: ID!
  permissions: SharePermission!
  expiresAt: AWSDateTime
  sharedWithEmail: String!
  sharedAt: AWSDateTime!
}

type Note @model @auth(rules: [
  { allow: owner },
  { allow: groups, groups: ["Admin"] }
]) {
  id: ID!
  title: String!
  content: String
  tags: [String]
  isPinned: Boolean
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  OTHER
}

enum SharePermission {
  VIEW
  DOWNLOAD
  EDIT
}
```

### Step 5: Add S3 Storage

```
amplify add storage
```
```
? Select from one of the below mentioned services: Content (Images, audio, video, etc.)
✔ Provide a friendly name for your resource: · s3mediavault
✔ Provide bucket name: · personalmediavault32a622167d504360806cfbc107779
✔ Restrict access by? · Auth/Guest Users
✔ Who should have access: · Auth and guest users
✔ What kind of access do you want for Authenticated users? · create/update, read, delete
✔ What kind of access do you want for Guest users? · read
✔ Do you want to add a Lambda Trigger for your S3 Bucket? (y/N) · no
```

### Step 6: Add Lambda Function

```
amplify add function
```
```
? Select which capability you want to add: Lambda function (serverless function)
? Provide an AWS Lambda function name: thumbnailgen
? Choose the runtime that you want to use: NodeJS
? Choose the function template that you want to use: Hello World
? Do you want to configure advanced settings? No
? Do you want to edit the local lambda function now? Yes
Edit the file in your editor: amplify/backend/function/thumbnailgen/src/index.js
? Press enter to continue
```
In `amplify/backend/function/thumbnailgen/src/index.js`, replace with:

```javascript
const { S3Client, GetObjectCommand, PutObjectCommand } = require('@aws-sdk/client-s3');

const s3 = new S3Client({ region: process.env.AWS_REGION });

/**
 * @type {import('@types/aws-lambda').S3Handler}
 */
exports.handler = async (event) => {
    console.log(`EVENT: ${JSON.stringify(event)}`);

    for (const record of event.Records) {
        const bucket = record.s3.bucket.name;
        const key = decodeURIComponent(record.s3.object.key.replace(/\+/g, ' '));

        // Skip if already a thumbnail
        if (key.includes('/thumbnails/')) {
            continue;
        }

        // Only process image files
        if (!key.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
            continue;
        }

        try {
            // Get file metadata
            const getCommand = new GetObjectCommand({ Bucket: bucket, Key: key });
            const fileData = await s3.send(getCommand);
            
            console.log(`Processing image: ${key}`);
            console.log(`File size: ${fileData.ContentLength} bytes`);
            console.log(`Content type: ${fileData.ContentType}`);
            
            // Create a simple text file as "thumbnail" for now
            const thumbnailKey = key.replace(/^(.+)\/([^/]+)$/, '$1/thumbnails/$2') + '.txt';
            const thumbnailContent = `Thumbnail info for: ${key}\nSize: ${fileData.ContentLength} bytes\nType: ${fileData.ContentType}`;
            
            const putCommand = new PutObjectCommand({
                Bucket: bucket,
                Key: thumbnailKey,
                Body: thumbnailContent,
                ContentType: 'text/plain'
            });
            await s3.send(putCommand);
            
            console.log(`Thumbnail info created: ${thumbnailKey}`);
            
        } catch (error) {
            console.error(`Error processing ${key}:`, error);
        }
    }

    return { statusCode: 200, body: 'Thumbnails processed' };
};
```

In `amplify/backend/function/thumbnailgen/src/package.json`, replace with:

```json
{
  "name": "thumbnailgen",
  "version": "2.0.0",
  "description": "Lambda function generated by Amplify",
  "main": "index.js",
  "license": "Apache-2.0",
  "dependencies": {
    "@aws-sdk/client-s3": "^3.0.0"
  },
  "devDependencies": {
    "@types/aws-lambda": "^8.10.92"
  }
}
```

In `amplify/backend/function/thumbnailgen/thumbnailgen-cloudformation-template.json`, add S3 permissions to the `PolicyDocument.Statement` array:

```json
{
  "Effect": "Allow",
  "Action": [
    "s3:GetObject",
    "s3:PutObject"
  ],
  "Resource": "arn:aws:s3:::*/*"
}
```

### Step 7: Deploy

```
amplify push
```
```
npm install && npm run dev
```

After deploying on amplify console copy your domain and continue:
```
amplify update auth
```
```
Using service: Cognito, provided by: awscloudformation
 What do you want to do? Add/Edit signin and signout redirect URIs
 Which redirect signin URIs do you want to edit? 
 Do you want to add redirect signin URIs? Yes
 Enter your new redirect signin URI: https://main.<appId>.amplifyapp.com/
? Do you want to add another redirect signin URI No
 Which redirect signout URIs do you want to edit? 
 Do you want to add redirect signout URIs? Yes
 Enter your new redirect signout URI: https://main.<appId>.amplifyapp.com/
? Do you want to add another redirect signout URI No
```

**Before deploying the Gen2 branch**, you must add OAuth provider secrets:

1. Go to Amplify Console → `<your-app-name>` → Hosting → Secrets  
   - Add the following secrets (use the same values from your Gen1 setup):   
       FACEBOOK_CLIENT_ID = (your Facebook App ID)  
       FACEBOOK_CLIENT_SECRET = (your Facebook App Secret)   
       GOOGLE_CLIENT_ID = (your Google Web Client ID)   
       GOOGLE_CLIENT_SECRET = (your Google Web Client Secret)   
   - Save and redeploy the `gen2-main` branch   

1. Go to https://developers.facebook.com:   
   - Get cognito domain from cognito -> userpool -> `<userpoolname>` -> domain and replace in the next steps     
   - In Settings -> Basic -> App Domains paste:   
       your app's URI: `https://main.<appId>.amplifyapp.com`   
       cognito domain: `https://personalmediavaultXXXXX-<env>.auth.<region>.amazoncognito.com`      
   - In Use Cases -> Customize Facebook Login -> Setting -> valid OAuth Redirect URIs paste:        
       your app's OAuth URI: `https://main.<appId>.amplifyapp.com/oauth2/idpresponse/`    
       cognito domain: `https:/personalmediavaultXXXXX-<env>.auth.<region>.amazoncognito.com`         
   - Click Save changes    

2. Go to https://console.developers.google.com/   
   - On the left navigation bar, look for credentials under APIs and Services under Pinned   
   - Click on the project which we created during setup (amplify test)    
   - Click on the earlier created OAuth 2.0 client ID   
   - In Authorized JavaScript origins paste   
       your app's URI: `https://main.<appId>.amplifyapp.com`   
       cognito domain: `https://personalmediavaultXXXXX-<env>.auth.<region>.amazoncognito.com`    

   - In Authorized redirect URI paste:   
       your app's OAuth URI: `https://main.<appId>.amplifyapp.com/oauth2/idpresponse/`   
       cognito OAuth domain: `https://personalmediavaultXXXXX-<env>.auth.<region>.amazoncognito.com/oauth2/idpresponse`    
   - Click save   

## Architecture

**Technology Stack**
- Frontend: React 18 + TypeScript + Vite
- Backend: AWS Amplify with GraphQL API
- Database: AWS DynamoDB (via Amplify)
- Storage: AWS S3 (for media files)
- Authentication: AWS Cognito with social providers

**Backend Features**
- User profiles with social authentication
- Media items with S3 storage integration
- Collections for organizing media
- Sharing functionality with permissions
- Quick notes management
- Thumbnail generation via Lambda

**User Experience**
- Social login (Facebook/Google) or email/phone
- Drag & drop file upload with progress tracking
- Real-time thumbnail processing status
- Collection-based media organization
- Role-based access (Admin/Basic groups) 

## Summary of changes required during Gen1 to Gen2 migration:

1. In `amplify/backend.ts`:
   
Line 80:  
before: `const cfnGraphQLApi = backend.data.resources.cfnResources.cfnGraphQLApi;`    
after: `const cfnGraphqlApi = backend.data.resources.cfnResources.cfnGraphqlApi;`  
  
Line 51 (remove this line entirely):    
after: (delete this line)    

3. In `src/main.tsx`:
      
before: `import amplifyconfig from './amplifyconfiguration.json';`    
after: `import amplifyconfig from '../amplify_outputs.json';`   

4. In `amplify/function/thumbnailgen/resource.ts`:
   
before: `entry: "index.handler",`     
after: `entry: "index.js",`   

5. In `amplify/data/resource.ts`:

after: Add `apiKeyAuthorizationMode: { expiresInDays: 100 }` to authorizationModes. 
 
After deployment suceeds: 
  
1. Go to https://developers.facebook.com:     
   - Get cognito domain from cognito -> userpool -> `<userpoolname>` -> domain and replace in the next steps     
   - In Settings -> Basic -> App Domains paste:   
       your app's URI: `https://gen2-main.<appId>.amplifyapp.com`   
       cognito domain: `https://<XXXXX>.auth.<region>.amazoncognito.com`      
   - In Use Cases -> Customize Facebook Login -> Setting -> valid OAuth Redirect URIs paste:        
       your app's OAuth URI: https://gen2main.<appId>.amplifyapp.com/oauth2/idpresponse/   
       cognito domain: `https://<XXXXX>.auth.<region>.amazoncognito.com`        
  

2. Go to https://console.developers.google.com:   
   - On the left navigation bar, look for credentials under APIs and Services under Pinned   
   - Click on the project which we created during setup (amplify test)   
   - Click on the earlier created OAuth 2.0 client ID   
   - In Authorized JavaScript origins paste:     
       your app's URI: `https://gen2-main.<appId>.amplifyapp.com`   
       cognito domain: `https://<XXXXX>.auth.<region>.amazoncognito.com`    

   - In Authorized redirect URI paste:  
       your app's OAuth URI: `https://gen2main.<appId>.amplifyapp.com/oauth2/idpresponse/`  
       cognito OAuth domain: `https://<XXXXX>.auth.<region>.amazoncognito.com/oauth2/idpresponse`    
   - Click on Save  

4. In `amplify/auth/resource.ts`:  

Line 25:    
after: Add `"https://gen2-main.<appId>.amplifyapp.com/"` to callbackUrls array  

Line 26:    
after: Add `"https://gen2-main.<appId>.amplifyapp.com/"` to logoutUrls array   

5. In `amplify/backend.ts`   

Line 40:     
after: Add `"https://gen2-main.<appId>.amplifyapp.com/"` to callbackUrls array  
      
Line 41:     
after: Add `"https://gen2-main.<appId>.amplifyapp.com/"` to logoutUrls array   
