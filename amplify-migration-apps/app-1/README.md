# Product Catalog - Amplify Gen1 Setup Guide

An inventory management application built with Amplify Gen1, featuring role-based authentication, GraphQL API, Lambda functions, S3 storage, and DynamoDB.

## Categories

### api
GraphQL API with schema containing Product, User, and Comment models with one-to-many relationships. Uses IAM for default auth with API key and Cognito as additional auth types. Includes custom query (checkLowStock) that invokes Lambda function for low stock monitoring.

### auth
Cognito-based authentication using email with role-based access control (ADMIN, MANAGER, VIEWER). Auto-configured during API setup.

### storage
- DynamoDB tables for Products, Users, and Comments (auto-generated by @model directive)
- S3 bucket (productimages3bucket) for authenticated users to create/update, read, and delete product images

### function
Node.js Lambda function (lowstockproductcatalog) that queries products via GraphQL API and returns list of products with stock below threshold (default: 5 units).

### hosting
Amplify Console-managed hosting with automatic deployments from GitHub.

## Description

This is an inventory management app with role-based access control. Products contain serial numbers, names, prices, categories, stock levels, brands, descriptions, and images stored in S3.

Users must sign up with email. First user becomes ADMIN automatically, subsequent users start as VIEWER. Once authenticated, users can perform actions based on their role: ADMIN (full access, user management), MANAGER (create/edit products), VIEWER (read-only, comments).

Product images are stored in S3 bucket (productimages3bucket) with auth-only access. Low stock monitoring is handled via Lambda function (lowstockproductcatalog) invoked through GraphQL checkLowStock query. Products, Users, and Comments use DynamoDB tables auto-generated by Amplify's @model directive. CRUD operations are via GraphQL with AWS AppSync. Auth is managed through Cognito with IAM as primary authorization and API key for public read access. Hosting is managed through Amplify Console.

---



 ### Step 1: Initialize the project

```
amplify init
```
```
Do you want to continue with Amplify Gen 1? (y/N) · yes  
Why would you like to use Amplify Gen 1? · Prefer not to answer  
Enter a name for the project productcatalog  

The following configuration will be applied:  
Project information  
| Name: productcatalog 
| Environment: dev  
| Default editor: Visual Studio Code  
| App type: javascript  
| Javascript framework: react
| Source Directory Path: src  
| Distribution Directory Path: dist  
| Build Command: npm run-script build  
| Start Command: npm run-script start  

? Initialize the project with the above configuration? Yes  
Using default provider awscloudformation  
? Select the authentication method you want to use: AWS profile
? Please choose the profile you want to use: default
```

### Step 2: Add GraphQL API

```
amplify add api
```
```
? Select from one of the below mentioned services: GraphQL
? Here is the GraphQL API that we will create. Select a setting to edit or continue Authorization modes: API key (default, expiration time: 7 days from now)
? Choose the default authorization type for the API IAM
? Configure additional auth types? Yes
? Choose the additional authorization types you want to configure for the API API key, Amazon Cognito User Pool
API key configuration
✔ Enter a description for the API key: · graphqlapi
✔ After how many days from now the API key should expire (1-365): · 7
Cognito UserPool configuration
Using service: Cognito, provided by: awscloudformation
 
 The current configured provider is Amazon Cognito. 
 
 Do you want to use the default authentication and security configuration? Default configuration
 Warning: you will not be able to edit these selections. 
 How do you want users to be able to sign in? Email
 Do you want to configure advanced settings? No, I am done.

? Here is the GraphQL API that we will create. Select a setting to edit or continue Continue
? Choose a schema template: One-to-many relationship (e.g., “Blogs” with “Posts” and “Comments”)

✔ Do you want to edit the schema now? (Y/n) · yes

Edit the file in your editor: /amplify/backend/api/<function-name>/schema.graphql
```

```graphql
# Multi-user Product Catalog with IAM-based Role Access Control

enum UserRole {
  ADMIN
  MANAGER
  VIEWER
}

type User @model @auth(rules: [
  { allow: private, provider: iam },
  { allow: owner, ownerField: "id" }
]) {
  id: ID!
  email: String!
  name: String!
  role: UserRole!
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

type Product @model @auth(rules: [
  { allow: private, provider: iam },
  { allow: public, provider: apiKey, operations: [read] }
]) {
  id: ID!
  serialno: Int!
  engword: String!
  price: Float
  category: String
  description: String
  stock: Int
  brand: String
  imageKey: String
  images: [String]
  createdBy: String
  updatedBy: String
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
  comments: [Comment] @hasMany(indexName: "byProduct", fields: ["id"])
}

type Comment @model @auth(rules: [
  { allow: private, provider: iam },
  { allow: owner, ownerField: "authorId" }
]) {
  id: ID!
  productId: ID! @index(name: "byProduct")
  product: Product @belongsTo(fields: ["productId"])
  authorId: String!
  authorName: String!
  content: String!
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

type LowStockProduct {
  name: String!
  stock: Int!
}

type LowStockResponse {
  message: String!
  lowStockProducts: [LowStockProduct!]!
}

type Query {
  checkLowStock: LowStockResponse @function(name: "lowstockproductcatalog-${env}") @auth(rules: [
    { allow: private, provider: iam },
    { allow: public, provider: apiKey }
  ])
}
```
### Step 3: Add S3 Storage

```
amplify add storage
```
```
? Select from one of the below mentioned services: Content (Images, audio, video, etc.)
✔ Provide a friendly name for your resource that will be used to label this category in the project: · productimages3
✔ Provide bucket name: · productimages3bucket
✔ Who should have access: · Auth users only
✔ What kind of access do you want for Authenticated users? · create/update, read, delete
✔ Do you want to add a Lambda Trigger for your S3 Bucket? (y/N) · no
```

### Step 4: Add Lambda function to display low stock alerts

```
amplify add function
```
```
 Select which capability you want to add: Lambda function (serverless function)
? Provide an AWS Lambda function name: lowstockproductcatalog
? Choose the runtime that you want to use: NodeJS
? Choose the function template that you want to use: Hello World

 Do you want to configure advanced settings? Yes
? Do you want to access other resources in this project from your Lambda function? Yes
? Select the categories you want this function to have access to. 
 ◉ api
 ◯ auth
 ◯ storage

? Select the operations you want to permit on productcatalog Query
? Do you want to invoke this function on a recurring schedule? No
? Do you want to enable Lambda layers for this function? No
? Do you want to configure environment variables for this function? No
? Do you want to configure secret values this function can access? No
✔ Choose the package manager that you want to use: · NPM

Do you want to edit the local lambda function now? Yes
Edit the file in your editor: amplify/backend/function/lowstockproductcatalog/src/index.js
? Press enter to continue
```
In the lowstockproductcatalog/src/index.js file, replace existing code with the following code.
**Note: Make sure the commented out portion at the beginning does not get deleted.** 

```
const https = require('https');

const GRAPHQL_ENDPOINT = process.env.API_PRODUCTCATALOG_GRAPHQLAPIENDPOINTOUTPUT;
const GRAPHQL_API_KEY = process.env.API_PRODUCTCATALOG_GRAPHQLAPIKEYOUTPUT;
const LOW_STOCK_THRESHOLD = parseInt(process.env.LOW_STOCK_THRESHOLD) || 5;

const listProductsQuery = `
  query ListProducts {
    listProducts {
      items {
        id
        engword
        stock
        price
        category
      }
    }
  }
`;

exports.handler = async (event) => {
    console.log(`EVENT: ${JSON.stringify(event)}`);
    
    try {
        const products = await fetchProducts();
        const lowStockProducts = products.filter(product => 
            product.stock !== null && product.stock < LOW_STOCK_THRESHOLD
        );
        
        console.log(`Found ${lowStockProducts.length} low stock products`);
        
        return {
            message: `Checked ${products.length} products, found ${lowStockProducts.length} low stock items`,
            lowStockProducts: lowStockProducts.map(p => ({
                name: p.engword,
                stock: p.stock
            }))
        };
        
    } catch (error) {
        console.error('Error checking stock:', error.message);
        console.error('Full error:', error);
        throw new Error(`Error checking stock: ${error.message}`);
    }
};

async function fetchProducts() {
    return new Promise((resolve, reject) => {
        const postData = JSON.stringify({
            query: listProductsQuery
        });
        
        const url = new URL(GRAPHQL_ENDPOINT);
        const options = {
            hostname: url.hostname,
            port: 443,
            path: url.pathname,
            method: 'POST',
            headers: {
                'content-type': 'application/json',
                'x-api-key': GRAPHQL_API_KEY,
                'Content-Length': Buffer.byteLength(postData)
            }
        };
        
        const req = https.request(options, (res) => {
            let data = '';
            
            res.on('data', (chunk) => {
                data += chunk;
            });
            
            res.on('end', () => {
                try {
                    const response = JSON.parse(data);
                    if (response.errors) {
                        reject(new Error(response.errors[0].message));
                    } else {
                        resolve(response.data.listProducts.items || []);
                    }
                } catch (error) {
                    reject(error);
                }
            });
        });
        
        req.on('error', (error) => {
            reject(error);
        });
        
        req.write(postData);
        req.end();
    });
}
```

```
amplify push
```
```
npm install
```

## Architecture

**Technology Stack**

- Frontend: React 19 + TypeScript + Vite
- Backend: AWS Amplify with GraphQL API
- Database: AWS DynamoDB (via Amplify)
- Storage: AWS S3 (for product images)
- Authentication: AWS Cognito

**Backend Features**

-> Core Data Models:
- Products - Complete product catalog with:
- Serial numbers, names, prices, categories
- Stock levels, brands, descriptions
- Image storage with S3 integration

-> Users - Multi-role user management:
- ADMIN: Full system access, user management
- MANAGER: Product creation/editing capabilities
- VIEWER: Read-only access

-> AWS Services Integration
- GraphQL API with AWS AppSync for real-time data
- S3 Storage for product image uploads
- Cognito Authentication with role-based access control
- Lambda Functions for business logic (low stock monitoring)

**User Experience**

-> Authentication Flow:
- Sign-up/Sign-in via AWS Cognito
- Automatic Role Assignment: First user becomes Admin, others start as Viewers
- Role-based Interface: UI adapts based on user permissions

**Daily Workflow**

-> For Admins:
- Full dashboard access with all management tools
- Create/edit/delete products with rich form interface
- Manage user roles and permissions
- Download inventory reports
- Monitor low stock alerts

-> For Managers:
- Product creation and editing capabilities
- Access to inventory reports
- Comment on products
- View all products with search/filter

-> For Viewers:
- Browse product catalog
- Search and filter products
- Add comments to products
- View product details and images


## Summary of changes required during Gen1 to Gen2 migration:

Post `amplify gen2-migration generate` :  

1. In `amplify/data/resource.ts`
   
before: `branchName: "main",`  
after: `branchName: "gen2-main",`

2. In `src/main.tsx`
   
before: `import amplifyconfig from '../amplifyconfiguration.json';`  
after: `import amplifyconfig from '../amplify_outputs.json';`

3. In `amplify/function/lowstockproductcatalog/handler.ts`

before: `const LOW_STOCK_THRESHOLD = parseInt(process.env.LOW_STOCK_THRESHOLD) || 5;`  
after: `const LOW_STOCK_THRESHOLD = parseInt(process.env.LOW_STOCK_THRESHOLD ?? '5');`

before: `exports.handler = async (event) => {`  
after: `export const handler = async (event: any) => {`

before: `const products = await fetchProducts();`  
after: `const products = await fetchProducts() as any[];`

before: `} catch (error) {`  
after: `} catch (error: any) {`

before: `const url = new URL(GRAPHQL_ENDPOINT);`  
after: `const url = new URL(GRAPHQL_ENDPOINT ?? '');`

before: `const req = https.request(options, (res) => {`  
after: `const req = https.request(options, (res: any) => {`

before: `res.on('data', (chunk) => {`  
after: `res.on('data', (chunk: any) => {`

before: `req.on('error', (error) => {`  
after: `req.on('error', (error: any) => {`

4. In `amplify/data/resource.ts`:  

before: `authorizationModes: {   
    defaultAuthorizationMode: "iam"   
}`  
after: `authorizationModes: {   
    defaultAuthorizationMode: "iam",   
    apiKeyAuthorizationMode: { expiresInDays: 7 }   
}`   

5. In `amplify/backend.ts`:

add after defineBackend():   
```typescript

const cfnGraphQLApi = backend.data.resources.cfnResources.cfnGraphqlApi;
cfnGraphQLApi.additionalAuthenticationProviders = [
  {
    authenticationType: 'AMAZON_COGNITO_USER_POOLS',
    userPoolConfig: {
      userPoolId: backend.auth.resources.userPool.userPoolId,
      awsRegion: backend.auth.resources.userPool.stack.region
    }
  }
];
```

6. In `amplify/data/resource.ts` (schema section)
    
before: `@function(name: "lowstockproductcatalog-\${env}")`  
after: `@function(name: "lowstockproductcatalog-gen2-main")`











