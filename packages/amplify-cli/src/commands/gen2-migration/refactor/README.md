# Refactor Command

The entrypoint into this command is `index.ts`, which exports code from `refactor.ts`.

## Overview

The `refactor` command is responsible for migrating resources from Gen1 (Amplify CLI) CloudFormation stacks to Gen2 (Amplify Gen 2) stacks. It provides an interactive workflow that assesses available resources, allows selective migration, and generates the necessary CloudFormation templates for the migration.

## Limitations
- Storage refactor only supports S3, not DynamoDB right now
- Auth is broken if using OAuth (fails on deployment after refactor command, when it tries to replace the IdP, which will already exist)
- No refactor for data, it is migrated in the "generate" step using a mapping

## Command Structure

The refactor command implements the `AmplifyMigrationStep` interface with three main phases:

### 1. `validate()`

Validates parameters, checks prerequisites, and processes resource mappings before execution.

#### Flow:
1. **`extractParameters()`**
   - Extracts CLI parameters from the context:
     - `--from` (Gen1 source stack name) → stored in `this.fromStack`
     - `--to` (Gen2 destination stack name) → stored in `this.toStack`
     - `--resourceMappings` (optional JSON file path) → stored in `this.resourceMappings`

2. **`validateParameters()`**
   - Ensures both `--from` and `--to` parameters are provided
   - Throws an error if either is missing

3. **`checkPrerequisites()`**
   - Verifies Gen1 metadata exists at `.amplify/migration/amplify/backend/amplify-meta.json`
     - Path constant: `refactor.ts:MIGRATION_DIR` (line 30) = `'.amplify/migration'`
     - This file should have been generated by the `prepare` command
   - Validates AWS credentials by making an STS `GetCallerIdentity` call
     - Ensures the user is authenticated and has valid AWS credentials

4. **`processResourceMappings()`** (if `--resourceMappings` is provided)
   - Validates the file path starts with `file://` protocol prefix
   - Reads and parses the JSON file containing resource mappings
   - Validates the structure of each mapping:
     ```typescript
     {
       Source: { StackName: string, LogicalResourceId: string },
       Destination: { StackName: string, LogicalResourceId: string }
     }
     ```
   - Stores parsed mappings in `this.parsedResourceMappings`
   - If resource mappings are not provided, we create our own, using the same format as above

### 2. `execute()`

Performs the actual refactoring operation by assessing resources, generating templates, and executing the migration.

#### Flow:
1. **`initializeTemplateGenerator()`**
   - Gets AWS account ID via STS `GetCallerIdentity`
   - Reads Gen1 metadata from `.amplify/migration/amplify/backend/amplify-meta.json`
   - Extracts `AmplifyAppId` and `StackName` from metadata
   - Derives backend environment name from the stack name
   - Creates AWS service clients:
     - `CloudFormationClient` - for stack operations
     - `SSMClient` - for parameter store access
     - `CognitoIdentityProviderClient` - for Cognito operations
   - Initializes `TemplateGenerator` with source/destination stacks and AWS clients

2. **`templateGenerator.initializeForAssessment()`**
   - Parses category stacks to build a map of available resources
   - Prepares for resource assessment

3. **`assessAndSelectCategories()`** - Interactive category selection
   - **`assessCategoryResources()`**: For each category (auth, storage, analytics):
     - Retrieves the source stack template
     - Identifies resources that can be migrated using `templateGenerator.getResourcesToMigrate()`
       - This method uses `categoryGeneratorConfig` (see [Constants](#constants)) to filter resources
       - Source of truth: `generators/template-generator.ts:categoryGeneratorConfig` (lines 79-92)
     - Counts resources and identifies resource types
     - For auth category: checks if OAuth providers are configured
     - Builds assessment results with:
       - Category name
       - Resource count
       - Resource types list
       - OAuth detection flag
       - Source stack ID
   
   - Displays assessment results to the user
   - Prompts user to choose:
     - "Migrate all categories"
     - "Select specific categories" (interactive per-category selection)
     - "Cancel migration"
   - Returns array of selected category names

4. **`executeStackRefactor()`**
   - If no categories selected, exits early
   - Calls `templateGenerator.generateSelectedCategories()` with:
     - Selected categories array
     - Optional resource mappings
   - This generates CloudFormation templates in `.amplify/migration/templates/`
     - Output directory constant: `generators/template-generator.ts:TEMPLATES_DIR` (line 38) = `'.amplify/migration/templates'`
   - Emits usage analytics on success/failure

5. **Post-execution**
   - Displays success message and next steps
   - Provides guidance on reviewing generated templates
   - Links to migration documentation

### 3. `rollback()`

Cleans up generated files if the migration needs to be reverted. Not complete.

#### Flow:
1. Removes the generated templates directory (`.amplify/migration/templates/`)
   - Uses `generators/template-generator.ts:TEMPLATES_DIR` constant
2. Provides feedback on cleanup completion

## Constants (Sources of Truth)

### Supported Categories
- **`CATEGORIES`** (`generators/template-generator.ts:37`): `['auth', 'storage', 'analytics']`
  - Defines which categories are supported for migration

### Resources Eligible for Migration

The following constants in `generators/template-generator.ts` define which CloudFormation resource types can be migrated for each category:

- **`AUTH_RESOURCES_TO_REFACTOR`** (lines 43-49): Auth resources that can be migrated
  - `CFN_AUTH_TYPE.UserPool` (`types.ts:92`)
  - `CFN_AUTH_TYPE.UserPoolClient` (`types.ts:93`)
  - `CFN_AUTH_TYPE.IdentityPool` (`types.ts:94`)
  - `CFN_AUTH_TYPE.IdentityPoolRoleAttachment` (`types.ts:95`)
  - `CFN_AUTH_TYPE.UserPoolDomain` (`types.ts:96`)

- **`AUTH_USER_POOL_GROUP_RESOURCES_TO_REFACTOR`** (line 50): User pool group resources
  - `CFN_AUTH_TYPE.UserPoolGroup` (`types.ts:97`)

- **`STORAGE_RESOURCES_TO_REFACTOR`** (line 51): Storage resources
  - `CFN_S3_TYPE.Bucket` (`types.ts:101`)

- **`ANALYTICS_RESOURCES_TO_REFACTOR`** (line 52): Analytics resources
  - `CFN_ANALYTICS_TYPE.Stream` (`types.ts:105`)

### Category Configuration

- **`categoryGeneratorConfig`** (`generators/template-generator.ts:79-92`): Maps each category to its eligible resource types
  - Used by `getResourcesToMigrate()` to filter resources during assessment
  - Structure:
    ```typescript
    {
      auth: { resourcesToRefactor: AUTH_RESOURCES_TO_REFACTOR },
      'auth-user-pool-group': { resourcesToRefactor: AUTH_USER_POOL_GROUP_RESOURCES_TO_REFACTOR },
      storage: { resourcesToRefactor: STORAGE_RESOURCES_TO_REFACTOR },
      analytics: { resourcesToRefactor: ANALYTICS_RESOURCES_TO_REFACTOR }
    }
    ```

### Directory Constants

- **`MIGRATION_DIR`** (`refactor.ts:30`): `'.amplify/migration'` - Base directory for migration files
- **`TEMPLATES_DIR`** (`generators/template-generator.ts:38`): `'.amplify/migration/templates'` - Output directory for generated templates
- **`AMPLIFY_DIR`** (`refactor.ts:31`): `'amplify'` - Subdirectory for Amplify metadata

### Resource Type Enums

Defined in `types.ts`:
- **`CFN_AUTH_TYPE`** (lines 91-98): Cognito resource types
- **`CFN_S3_TYPE`** (lines 100-102): S3 resource types
- **`CFN_ANALYTICS_TYPE`** (lines 104-106): Kinesis resource types

### Logical ID Mapping

- **`GEN1_RESOURCE_TYPE_TO_LOGICAL_RESOURCE_IDS_MAP`** (`generators/template-generator.ts:53-61`): Maps Gen1 CloudFormation resource types to their logical resource IDs in Gen1 stacks

## Key Components

### TemplateGenerator
- Located in `generators/template-generator.ts`
- Handles the actual CloudFormation template generation
- Manages category-specific template generation via `CategoryTemplateGenerator`
- Processes resource mappings and logical ID transformations
- Generates migration templates for selected categories
- Uses `categoryGeneratorConfig` to determine which resources can be migrated

### CategoryTemplateGenerator
- Located in `generators/category-template-generator.ts`
- Category-specific template generation logic
- Handles resource type-specific transformations
- Manages OAuth provider metadata retrieval

### Resource Mappings
- Optional JSON file that maps resources from source to destination stacks
- Format: Array of objects with `Source` and `Destination` properties
- Allows custom control over resource migration paths
- If not provided, default mappings are created automatically

## Error Handling

The command includes comprehensive error handling with context-specific guidance:
- Stack not found errors
- AWS credentials/authentication issues
- Permission problems
- Resource mappings format errors
- Network connectivity issues

## Output

Generated templates are written to `.amplify/migration/templates/` with:
- Source and destination CloudFormation templates
- Migration README files with instructions
- Logical ID mappings for reference