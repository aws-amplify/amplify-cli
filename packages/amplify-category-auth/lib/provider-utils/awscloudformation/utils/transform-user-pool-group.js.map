{"version":3,"file":"transform-user-pool-group.js","sourceRoot":"","sources":["../../../../src/provider-utils/awscloudformation/utils/transform-user-pool-group.js"],"names":[],"mappings":";AAAA,MAAM,EAAE,aAAa,EAAE,WAAW,EAAE,GAAG,OAAO,CAAC,+BAA+B,CAAC,CAAC;AAChF,MAAM,IAAI,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC;AAC7B,MAAM,EAAE,kCAAkC,EAAE,GAAG,OAAO,CAAC,2CAA2C,CAAC,CAAC;AAEpG,KAAK,UAAU,4BAA4B,CAAC,OAAO;IACjD,MAAM,sBAAsB,GAAG,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,iBAAiB,EAAE,EAAE,MAAM,EAAE,gBAAgB,EAAE,iCAAiC,CAAC,CAAC;IAEvI,MAAM,EAAE,YAAY,EAAE,GAAG,MAAM,OAAO,CAAC,OAAO,CAAC,iBAAiB,EAAE,CAAC;IACnE,MAAM,YAAY,GAAG,YAAY,CAAC,MAAM,CAAC,CAAC,QAAQ,EAAE,EAAE,CAAC,QAAQ,CAAC,OAAO,KAAK,SAAS,CAAC,CAAC;IACvF,IAAI,gBAAgB,CAAC;IAErB,IAAI,YAAY,CAAC,MAAM,GAAG,CAAC,EAAE;QAC3B,MAAM,QAAQ,GAAG,YAAY,CAAC,CAAC,CAAC,CAAC;QACjC,gBAAgB,GAAG,QAAQ,CAAC,YAAY,CAAC;KAC1C;SAAM;QACL,MAAM,IAAI,KAAK,CAAC,kCAAkC,CAAC,CAAC;KACrD;IAED,MAAM,MAAM,GAAG,aAAa,CAAC,QAAQ,CAAC,sBAAsB,CAAC,CAAC;IAI9D,MAAM,CAAC,OAAO,CAAC,CAAC,KAAK,EAAE,EAAE;QACvB,IAAI,KAAK,CAAC,cAAc,EAAE;YACxB,KAAK,CAAC,cAAc,CAAC,OAAO,CAAC,CAAC,MAAM,EAAE,EAAE;gBACtC,IAAI,MAAM,CAAC,cAAc,IAAI,MAAM,CAAC,cAAc,CAAC,SAAS,EAAE;oBAC5D,MAAM,CAAC,cAAc,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC,SAAS,EAAE,EAAE;wBAEpD,IAAI,SAAS,CAAC,QAAQ,CAAC,QAAQ,CAAC,QAAQ,CAAC,EAAE;4BAEzC,SAAS,CAAC,QAAQ,GAAG,EAAE,SAAS,EAAE,CAAC,SAAS,CAAC,QAAQ,EAAE,EAAE,GAAG,EAAE,EAAE,GAAG,EAAE,KAAK,EAAE,EAAE,CAAC,EAAE,CAAC;yBACnF;oBACH,CAAC,CAAC,CAAC;iBACJ;YACH,CAAC,CAAC,CAAC;SACJ;IACH,CAAC,CAAC,CAAC;IACH,MAAM,kCAAkC,CAAC,OAAO,EAAE,gBAAgB,CAAC,CAAC;AACtE,CAAC;AAED,MAAM,CAAC,OAAO,GAAG;IACf,4BAA4B;CAC7B,CAAC","sourcesContent":["const { JSONUtilities, pathManager } = require('@aws-amplify/amplify-cli-core');\nconst path = require('path');\nconst { generateUserPoolGroupStackTemplate } = require('./generate-user-pool-group-stack-template');\n\nasync function transformUserPoolGroupSchema(context) {\n  const userPoolPrecedencePath = path.join(pathManager.getBackendDirPath(), 'auth', 'userPoolGroups', 'user-pool-group-precedence.json');\n\n  const { allResources } = await context.amplify.getResourceStatus();\n  const authResource = allResources.filter((resource) => resource.service === 'Cognito');\n  let authResourceName;\n\n  if (authResource.length > 0) {\n    const resource = authResource[0];\n    authResourceName = resource.resourceName;\n  } else {\n    throw new Error('Cognito UserPool does not exists');\n  }\n\n  const groups = JSONUtilities.readJson(userPoolPrecedencePath);\n\n  // Replace env vars with subs\n\n  groups.forEach((group) => {\n    if (group.customPolicies) {\n      group.customPolicies.forEach((policy) => {\n        if (policy.PolicyDocument && policy.PolicyDocument.Statement) {\n          policy.PolicyDocument.Statement.forEach((statement) => {\n            // eslint-disable-next-line\n            if (statement.Resource.includes('${env}')) {\n              // eslint-disable-line\n              statement.Resource = { 'Fn::Sub': [statement.Resource, { env: { Ref: 'env' } }] };\n            }\n          });\n        }\n      });\n    }\n  });\n  await generateUserPoolGroupStackTemplate(context, authResourceName);\n}\n\nmodule.exports = {\n  transformUserPoolGroupSchema,\n};\n"]}