{"version":3,"file":"update.js","sourceRoot":"","sources":["../../../src/commands/auth/update.ts"],"names":[],"mappings":"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","sourcesContent":["import { ensureEnvParamManager } from '@aws-amplify/amplify-environment-parameters';\nimport {\n  $TSContext,\n  AmplifyCategories,\n  AmplifySupportedService,\n  BannerMessage,\n  FeatureFlags,\n  stateManager,\n} from '@aws-amplify/amplify-cli-core';\nimport { printer } from '@aws-amplify/amplify-prompts';\nimport _ from 'lodash';\nimport { category } from '../..';\nimport { AuthContext } from '../../context';\nimport { messages } from '../../provider-utils/awscloudformation/assets/string-maps';\nimport * as providerController from '../../provider-utils/awscloudformation/index';\nimport { checkAuthResourceMigration } from '../../provider-utils/awscloudformation/utils/check-for-auth-migration';\nimport { getSupportedServices } from '../../provider-utils/supported-services';\nimport { getAuthResourceName } from '../../utils/getAuthResourceName';\n\nexport const name = 'update';\nexport const alias = ['update'];\n\n/**\n * entry point to update auth resource\n */\nexport const run = async (context: AuthContext): Promise<string | $TSContext | undefined> => {\n  const { amplify } = context;\n  const servicesMetadata = getSupportedServices();\n  const meta = stateManager.getMeta();\n  const existingAuth = meta.auth ?? {};\n  if (_.isEmpty(existingAuth)) {\n    printer.warn('Project does not contain auth resources. Add auth using `amplify add auth`.');\n    return undefined;\n  }\n  const authResources = Object.keys(existingAuth);\n  for (const authResourceName of authResources) {\n    const serviceMeta = existingAuth[authResourceName];\n    if (serviceMeta.service === AmplifySupportedService.COGNITO && serviceMeta.mobileHubMigrated === true) {\n      printer.error('Auth is migrated from Mobile Hub and cannot be updated with Amplify CLI.');\n      return context;\n    }\n    if (serviceMeta.service === AmplifySupportedService.COGNITO && serviceMeta.serviceType === 'imported') {\n      printer.error('Updating imported Auth resource is not supported.');\n      return context;\n    }\n    if (serviceMeta.service === AmplifySupportedService.COGNITO && !FeatureFlags.getBoolean('auth.forceAliasAttributes')) {\n      const authAttributes = stateManager.getResourceParametersJson(undefined, AmplifyCategories.AUTH, authResourceName);\n      if (authAttributes.aliasAttributes && authAttributes.aliasAttributes.length > 0) {\n        const authUpdateWarning = await BannerMessage.getMessage('AMPLIFY_UPDATE_AUTH_ALIAS_ATTRIBUTES_WARNING');\n        if (authUpdateWarning) {\n          printer.warn(authUpdateWarning);\n        }\n      }\n    }\n  }\n\n  printer.info('Please note that certain attributes may not be overwritten if you choose to use defaults settings.');\n  const dependentResources = Object.keys(meta).some(\n    (e) => ['analytics', 'api', 'storage', 'function'].includes(e) && Object.keys(meta[e]).length > 0,\n  );\n  if (dependentResources) {\n    printer.info(messages.dependenciesExists);\n  }\n  const resourceName = await getAuthResourceName(context);\n  await checkAuthResourceMigration(context, resourceName, true);\n  const providerPlugin = context.amplify.getPluginInstance(context, servicesMetadata.Cognito.provider);\n  await ensureEnvParamManager();\n  context.updatingAuth = providerPlugin.loadResourceParameters(context, 'auth', resourceName);\n\n  try {\n    const result = await amplify.serviceSelectionPrompt(context, category, getSupportedServices());\n    const options = {\n      service: result.service,\n      providerPlugin: result.providerName,\n      resourceName,\n    };\n    if (!providerController) {\n      printer.error('Provider not configured for this category');\n      return undefined;\n    }\n    const updateResourceResponse = await providerController.updateResource(context, options);\n    printer.success(`Successfully updated resource ${name} locally`);\n    printer.blankLine();\n    printer.success('Some next steps:');\n    printer.info('\"amplify push\" will build all your local backend resources and provision it in the cloud');\n    printer.info(\n      '\"amplify publish\" will build all your local backend and frontend resources (if you have hosting category added) and provision it in the cloud',\n    );\n    printer.blankLine();\n    return updateResourceResponse;\n  } catch (err) {\n    printer.info(err.stack);\n    printer.error('There was an error adding the auth resource');\n    void context.usageData.emitError(err);\n    process.exitCode = 1;\n    return undefined;\n  }\n};\n"]}