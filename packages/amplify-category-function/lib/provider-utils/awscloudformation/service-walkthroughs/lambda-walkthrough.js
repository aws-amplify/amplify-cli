"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.updateCFNFileForResourcePermissions = exports.migrate = exports.updateWalkthrough = exports.buildTopLevelComment = exports.buildShowEnvVars = exports.createWalkthrough = void 0;
const amplify_cli_core_1 = require("amplify-cli-core");
const inquirer_1 = __importDefault(require("inquirer"));
const lodash_1 = __importDefault(require("lodash"));
const path_1 = __importDefault(require("path"));
const constants_1 = require("../../../constants");
const cloudformationHelpers_1 = require("../utils/cloudformationHelpers");
const constants_2 = require("../utils/constants");
const funcParamsUtils_1 = require("../utils/funcParamsUtils");
const functionPluginLoader_1 = require("../utils/functionPluginLoader");
const layerArnConverter_1 = require("../utils/layerArnConverter");
const loadFunctionParameters_1 = require("../utils/loadFunctionParameters");
const environmentVariablesHelper_1 = require("../utils/environmentVariablesHelper");
const environmentVariableWalkthrough_1 = require("./environmentVariableWalkthrough");
const permissionMapUtils_1 = require("../utils/permissionMapUtils");
const consolidateDependsOn_1 = require("../utils/consolidateDependsOn");
const secretValuesWalkthrough_1 = require("./secretValuesWalkthrough");
const secretDeltaUtilities_1 = require("../secrets/secretDeltaUtilities");
const functionSecretsStateManager_1 = require("../secrets/functionSecretsStateManager");
const updateTopLevelComment_1 = require("../utils/updateTopLevelComment");
const addLayerToFunctionWalkthrough_1 = require("./addLayerToFunctionWalkthrough");
const autogeneratedParameters_1 = require("./autogeneratedParameters");
const execPermissionsWalkthrough_1 = require("./execPermissionsWalkthrough");
const generalQuestionsWalkthrough_1 = require("./generalQuestionsWalkthrough");
const scheduleWalkthrough_1 = require("./scheduleWalkthrough");
const createWalkthrough = async (context, templateParameters) => {
    templateParameters = (0, funcParamsUtils_1.merge)(templateParameters, (0, autogeneratedParameters_1.autoGeneratedParameters)(context));
    if (!templateParameters.functionName) {
        templateParameters = (0, funcParamsUtils_1.merge)(templateParameters, await (0, generalQuestionsWalkthrough_1.generalQuestionsWalkthrough)(context));
    }
    if (templateParameters.functionName) {
        templateParameters.resourceName = templateParameters.functionName;
    }
    if (!templateParameters.runtime) {
        const runtimeSelection = await (0, functionPluginLoader_1.runtimeWalkthrough)(context, templateParameters);
        templateParameters = (0, funcParamsUtils_1.merge)(templateParameters, runtimeSelection[0]);
    }
    templateParameters = (0, funcParamsUtils_1.merge)(templateParameters, await (0, functionPluginLoader_1.templateWalkthrough)(context, templateParameters));
    if (templateParameters.skipAdvancedSection) {
        return templateParameters;
    }
    context.print.info('');
    context.print.success('Available advanced settings:');
    constants_2.advancedSettingsList.forEach((setting) => context.print.info('- '.concat(setting)));
    context.print.info('');
    if (await context.amplify.confirmPrompt('Do you want to configure advanced settings?', false)) {
        if (await context.amplify.confirmPrompt('Do you want to access other resources in this project from your Lambda function?')) {
            templateParameters = (0, funcParamsUtils_1.merge)(templateParameters, await (0, execPermissionsWalkthrough_1.askExecRolePermissionsQuestions)(context, templateParameters.functionName, undefined, templateParameters.environmentMap));
        }
        templateParameters = (0, funcParamsUtils_1.merge)(templateParameters, await (0, scheduleWalkthrough_1.scheduleWalkthrough)(context, templateParameters));
        templateParameters = (0, funcParamsUtils_1.merge)(templateParameters, await (0, addLayerToFunctionWalkthrough_1.addLayersToFunctionWalkthrough)(context, templateParameters.runtime));
        if (await context.amplify.confirmPrompt('Do you want to configure environment variables for this function?', false)) {
            templateParameters = (0, funcParamsUtils_1.merge)(templateParameters, await (0, environmentVariableWalkthrough_1.askEnvironmentVariableQuestions)(templateParameters.functionName));
            templateParameters.topLevelComment = (0, exports.buildTopLevelComment)(templateParameters.environmentMap);
            const envVarViewString = (0, exports.buildShowEnvVars)(templateParameters.environmentMap);
            context.print.info(envVarViewString);
        }
        templateParameters = (0, funcParamsUtils_1.merge)(templateParameters, await (0, secretValuesWalkthrough_1.secretValuesWalkthrough)((0, secretDeltaUtilities_1.secretNamesToSecretDeltas)((0, functionSecretsStateManager_1.getLocalFunctionSecretNames)(templateParameters.functionName)), Object.keys((0, environmentVariablesHelper_1.getStoredEnvironmentVariables)(templateParameters.functionName))));
    }
    return templateParameters;
};
exports.createWalkthrough = createWalkthrough;
const buildShowEnvVars = (envVariableMap) => {
    const envVarViewArr = Object.keys(envVariableMap);
    const envVarViewString = envVarViewArr.join('\n\t');
    const showEnvComment = `${constants_1.envVarPrintoutPrefix}${envVarViewString}`;
    return showEnvComment;
};
exports.buildShowEnvVars = buildShowEnvVars;
const buildTopLevelComment = (envVariableMap) => {
    const envVarViewArr = Object.keys(envVariableMap);
    const envVarViewString = envVarViewArr.join('\n\t');
    const topLevelComment = `${constants_1.topLevelCommentPrefix}${envVarViewString}${constants_1.topLevelCommentSuffix}`;
    return topLevelComment;
};
exports.buildTopLevelComment = buildTopLevelComment;
const provideInformation = (context, lambdaToUpdate, functionRuntime, currentParameters, scheduleParameters) => {
    context.print.success('General information');
    context.print.info('- Name: '.concat(lambdaToUpdate));
    context.print.info('- Runtime: '.concat(functionRuntime));
    context.print.info('');
    context.print.success('Resource access permission');
    const currentCategoryPermissions = (0, permissionMapUtils_1.fetchPermissionCategories)(currentParameters.permissions);
    if (currentCategoryPermissions.length) {
        currentCategoryPermissions.forEach((category) => {
            const currentResources = (0, permissionMapUtils_1.fetchPermissionResourcesForCategory)(currentParameters.permissions, category);
            currentResources.forEach((resource) => {
                const currentPermissions = (0, permissionMapUtils_1.fetchPermissionsForResourceInCategory)(currentParameters.permissions, category, resource);
                const formattedCurrentPermissions = ' ('.concat(currentPermissions.join(', ').concat(')'));
                context.print.info('- '.concat(resource).concat(formattedCurrentPermissions));
            });
        });
    }
    else {
        context.print.info('- Not configured');
    }
    context.print.info('');
    context.print.success('Scheduled recurring invocation');
    if (scheduleParameters.cloudwatchRule && scheduleParameters.cloudwatchRule !== 'NONE') {
        context.print.info('- '.concat(scheduleParameters.cloudwatchRule));
        context.print.info('');
    }
    else {
        context.print.info('- Not configured');
        context.print.info('');
    }
    context.print.success('Lambda layers');
    if (currentParameters.lambdaLayers && currentParameters.lambdaLayers.length) {
        currentParameters.lambdaLayers.forEach((layer) => {
            if (layer.arn) {
                context.print.info('- '.concat(layer.arn));
            }
            else {
                context.print.info(`- ${layer.resourceName}`);
            }
        });
        context.print.info('');
    }
    else {
        context.print.info('- Not configured');
        context.print.info('');
    }
    context.print.success('Environment variables:');
    const storedEnvironmentVariables = (0, environmentVariablesHelper_1.getStoredEnvironmentVariables)(lambdaToUpdate);
    if (lodash_1.default.size(storedEnvironmentVariables) !== 0) {
        lodash_1.default.forEach(storedEnvironmentVariables, (environmentVariableValue, environmentVariableKey) => {
            context.print.info(`- ${environmentVariableKey}: ${environmentVariableValue}`);
        });
    }
    else {
        context.print.info('- Not configured');
    }
    context.print.info('');
    context.print.success('Secrets configuration');
    const currentSecrets = (0, functionSecretsStateManager_1.getLocalFunctionSecretNames)(lambdaToUpdate);
    if (currentSecrets.length) {
        currentSecrets.forEach((secretName) => context.print.info(`- ${secretName}`));
    }
    else {
        context.print.info('- Not configured');
    }
    context.print.info('');
};
const updateWalkthrough = async (context, lambdaToUpdate) => {
    const lambdaFuncResourceNames = (await context.amplify.getResourceStatus()).allResources
        .filter((resource) => resource.service === "Lambda" && resource.mobileHubMigrated !== true)
        .map((resource) => resource.resourceName);
    if (lambdaFuncResourceNames.length === 0) {
        context.print.error('No Lambda function resource to update. Use "amplify add function" to create a new function.');
        return undefined;
    }
    if (lambdaToUpdate) {
        if (!lambdaFuncResourceNames.includes(lambdaToUpdate)) {
            context.print.error(`No Lambda function named ${lambdaToUpdate} exists in the project.`);
            return undefined;
        }
    }
    else {
        const resourceQuestion = [
            {
                name: 'resourceName',
                message: 'Select the Lambda function you want to update',
                type: 'list',
                choices: lambdaFuncResourceNames,
            },
        ];
        lambdaToUpdate = (await inquirer_1.default.prompt(resourceQuestion)).resourceName;
    }
    const functionParameters = {
        resourceName: lambdaToUpdate,
        environmentMap: {
            ENV: {
                Ref: 'env',
            },
            REGION: {
                Ref: 'AWS::Region',
            },
        },
    };
    const projectBackendDirPath = amplify_cli_core_1.pathManager.getBackendDirPath();
    const resourceDirPath = path_1.default.join(projectBackendDirPath, constants_1.categoryName, functionParameters.resourceName);
    const currentParameters = (0, loadFunctionParameters_1.loadFunctionParameters)(resourceDirPath);
    const functionRuntime = context.amplify.readBreadcrumbs(constants_1.categoryName, functionParameters.resourceName).functionRuntime;
    const cfnParameters = amplify_cli_core_1.JSONUtilities.readJson(path_1.default.join(resourceDirPath, constants_2.parametersFileName), { throwIfNotExist: false }) || {};
    const scheduleParameters = {
        cloudwatchRule: cfnParameters.CloudWatchRule,
        resourceName: functionParameters.resourceName,
    };
    provideInformation(context, lambdaToUpdate, functionRuntime, currentParameters, scheduleParameters);
    const { selectedSettings } = await (0, generalQuestionsWalkthrough_1.settingsUpdateSelection)();
    if (selectedSettings.includes(constants_2.resourceAccessSetting)) {
        const additionalParameters = await (0, execPermissionsWalkthrough_1.askExecRolePermissionsQuestions)(context, lambdaToUpdate, currentParameters.permissions);
        additionalParameters.dependsOn = additionalParameters.dependsOn || [];
        (0, funcParamsUtils_1.merge)(functionParameters, additionalParameters);
        (0, exports.updateCFNFileForResourcePermissions)(resourceDirPath, functionParameters, currentParameters);
    }
    if (selectedSettings.includes(constants_2.cronJobSetting)) {
        (0, funcParamsUtils_1.merge)(functionParameters, await (0, scheduleWalkthrough_1.scheduleWalkthrough)(context, scheduleParameters, true));
    }
    if (selectedSettings.includes(constants_2.lambdaLayerSetting)) {
        const currentFunctionParameters = amplify_cli_core_1.JSONUtilities.readJson(path_1.default.join(resourceDirPath, constants_2.functionParametersFileName), { throwIfNotExist: false }) || {};
        (0, funcParamsUtils_1.merge)(functionParameters, await (0, addLayerToFunctionWalkthrough_1.addLayersToFunctionWalkthrough)(context, { value: functionRuntime }, currentFunctionParameters.lambdaLayers, true));
        addLayerCFNParameters(context, functionParameters, resourceDirPath);
    }
    if (selectedSettings.includes(constants_2.secretsConfiguration)) {
        (0, funcParamsUtils_1.merge)(functionParameters, await (0, secretValuesWalkthrough_1.secretValuesWalkthrough)((0, secretDeltaUtilities_1.secretNamesToSecretDeltas)((0, functionSecretsStateManager_1.getLocalFunctionSecretNames)(functionParameters.resourceName)), Object.keys((0, environmentVariablesHelper_1.getStoredEnvironmentVariables)(functionParameters.resourceName)), {
            preConfirmed: true,
        }));
    }
    const projectMeta = amplify_cli_core_1.stateManager.getMeta();
    functionParameters.dependsOn = (0, consolidateDependsOn_1.consolidateDependsOnForLambda)(projectMeta, functionParameters.dependsOn, lambdaToUpdate, selectedSettings);
    (0, funcParamsUtils_1.merge)(functionParameters, await (0, environmentVariableWalkthrough_1.askEnvironmentVariableQuestions)(lambdaToUpdate, undefined, !selectedSettings.includes(constants_2.environmentVariableSetting)));
    functionParameters.topLevelComment = (0, exports.buildTopLevelComment)(functionParameters.environmentMap);
    return functionParameters;
};
exports.updateWalkthrough = updateWalkthrough;
const migrate = (__, projectPath, resourceName) => {
    const resourceDirPath = amplify_cli_core_1.pathManager.getResourceDirectoryPath(projectPath, constants_1.categoryName, resourceName);
    const cfnFilePath = path_1.default.join(resourceDirPath, `${resourceName}-cloudformation-template.json`);
    const oldCfn = amplify_cli_core_1.JSONUtilities.readJson(cfnFilePath);
    const newCfn = {};
    Object.assign(newCfn, oldCfn);
    if (!newCfn.Parameters) {
        newCfn.Parameters = {};
    }
    newCfn.Parameters.env = {
        Type: 'String',
    };
    if (!newCfn.Conditions) {
        newCfn.Conditions = {};
    }
    newCfn.Conditions.ShouldNotCreateEnvResources = {
        'Fn::Equals': [
            {
                Ref: 'env',
            },
            'NONE',
        ],
    };
    const oldFunctionName = newCfn.Resources.LambdaFunction.Properties.FunctionName;
    newCfn.Resources.LambdaFunction.Properties.FunctionName = {
        'Fn::If': [
            'ShouldNotCreateEnvResources',
            oldFunctionName,
            {
                'Fn::Join': [
                    '',
                    [
                        oldFunctionName,
                        '-',
                        {
                            Ref: 'env',
                        },
                    ],
                ],
            },
        ],
    };
    newCfn.Resources.LambdaFunction.Properties.Environment = { Variables: { ENV: { Ref: 'env' } } };
    const oldRoleName = newCfn.Resources.LambdaExecutionRole.Properties.RoleName;
    newCfn.Resources.LambdaExecutionRole.Properties.RoleName = {
        'Fn::If': [
            'ShouldNotCreateEnvResources',
            oldRoleName,
            {
                'Fn::Join': [
                    '',
                    [
                        oldRoleName,
                        '-',
                        {
                            Ref: 'env',
                        },
                    ],
                ],
            },
        ],
    };
    amplify_cli_core_1.JSONUtilities.writeJson(cfnFilePath, newCfn);
};
exports.migrate = migrate;
const updateCFNFileForResourcePermissions = (resourceDirPath, functionParameters, currentParameters, apiResourceName) => {
    const cfnFileName = `${functionParameters.resourceName}-cloudformation-template.json`;
    const cfnFilePath = path_1.default.join(resourceDirPath, cfnFileName);
    const cfnContent = amplify_cli_core_1.JSONUtilities.readJson(cfnFilePath);
    const dependsOnParams = { env: { Type: 'String' } };
    Object.keys(functionParameters.environmentMap)
        .filter((key) => key !== 'ENV')
        .filter((key) => key !== 'REGION')
        .filter((resourceProperty) => 'Ref' in functionParameters.environmentMap[resourceProperty])
        .forEach((resourceProperty) => {
        dependsOnParams[functionParameters.environmentMap[resourceProperty].Ref] = {
            Type: 'String',
            Default: functionParameters.environmentMap[resourceProperty].Ref,
        };
    });
    cfnContent.Parameters = (0, cloudformationHelpers_1.getNewCFNParameters)(cfnContent.Parameters, currentParameters, dependsOnParams, functionParameters.mutableParametersState, apiResourceName);
    if (!cfnContent.Resources.AmplifyResourcesPolicy) {
        cfnContent.Resources.AmplifyResourcesPolicy = {
            DependsOn: ['LambdaExecutionRole'],
            Type: 'AWS::IAM::Policy',
            Properties: {
                PolicyName: 'amplify-lambda-execution-policy',
                Roles: [
                    {
                        Ref: 'LambdaExecutionRole',
                    },
                ],
                PolicyDocument: {
                    Version: '2012-10-17',
                    Statement: [],
                },
            },
        };
    }
    if (functionParameters.categoryPolicies.length === 0) {
        delete cfnContent.Resources.AmplifyResourcesPolicy;
    }
    else {
        cfnContent.Resources.AmplifyResourcesPolicy.Properties.PolicyDocument.Statement = functionParameters.categoryPolicies;
    }
    cfnContent.Resources.LambdaFunction.Properties.Environment.Variables = (0, cloudformationHelpers_1.getNewCFNEnvVariables)(cfnContent.Resources.LambdaFunction.Properties.Environment.Variables, currentParameters, functionParameters.environmentMap, functionParameters.mutableParametersState, apiResourceName);
    amplify_cli_core_1.JSONUtilities.writeJson(cfnFilePath, cfnContent);
    (0, updateTopLevelComment_1.tryUpdateTopLevelComment)(resourceDirPath, lodash_1.default.keys(functionParameters.environmentMap));
};
exports.updateCFNFileForResourcePermissions = updateCFNFileForResourcePermissions;
const addLayerCFNParameters = (context, functionParameters, resourceDirPath) => {
    const cfnFileName = `${functionParameters.resourceName}-cloudformation-template.json`;
    const cfnFilePath = path_1.default.join(resourceDirPath, cfnFileName);
    const cfnContent = amplify_cli_core_1.JSONUtilities.readJson(cfnFilePath);
    functionParameters.lambdaLayers.forEach((layer) => {
        const resourceName = lodash_1.default.get(layer, ['resourceName'], null);
        if (resourceName) {
            const param = `function${resourceName}Arn`;
            if (cfnContent.Parameters[param] === undefined) {
                cfnContent.Parameters[param] = {
                    Type: 'String',
                    Default: param,
                };
            }
        }
    });
    cfnContent.Resources.LambdaFunction.Properties.Layers = (0, layerArnConverter_1.convertLambdaLayerMetaToLayerCFNArray)(functionParameters.lambdaLayers, context.amplify.getEnvInfo().envName);
    amplify_cli_core_1.JSONUtilities.writeJson(cfnFilePath, cfnContent);
};
//# sourceMappingURL=lambda-walkthrough.js.map